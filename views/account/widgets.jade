extends ../layout

block extra_head
  script.
    require([
      'domReady',
      'angular',
      'jquery',
      'controllers/widget.list',
      'controllers/widget.delete',
      'controllers/sip.edit'
    ],
    function(domReady, angular, $, WidgetListController, DeleteWidgetController, EditSIPController) {
      //- adding a new require call to load other
      //- controllers after main one loads
      angular.module('voxboneApp', [])
        .controller('WidgetListController', WidgetListController)
        .controller('EditSIPController', EditSIPController)
        .controller('DeleteWidgetController', DeleteWidgetController);

      domReady(function() {
        angular.bootstrap(document, ['voxboneApp']);
      });

      $(document).on('hide.bs.collapse show.bs.collapse', '.sipCollapse', function() {
        var trigger = $('[data-toggle="collapse"][href="#' + $(this).attr('id') + '"]');
        trigger.find('i').toggleClass('glyphicon-chevron-down glyphicon-chevron-right');
      });

      $(document).on('click', '#callVoxbone', function() {
        $('.call-to-voxbone-button .vxb-widget-box #launch_call')[0].click();
      });
    });

block content
  .main.buttonList(ng-controller="WidgetListController")
    .header
      .container
        h1 Click2Vox Buttons
        if !currentUser.paid && !currentUser.upgrade_request
          p#upgrade_request Your trial account is authorized to create a single user-defined SIP URI and 5 simultaneous calls. #[a(href="#" ng-click='openRequestUpgradeModal(false)') Request a free upgrade]
        .actions-wrap
          if process.env.BYPASS_ADDING_SIP_URI === 'false'
            if currentUser.sip_uris.length > 0 && !currentUser.paid
              #[a.btn.btn-purple(ng-click='openRequestUpgradeModal(#{!!currentUser.upgrade_request})') Add SIP URI]
            else
              #[a.btn.btn-purple(href="/sip/new") Add SIP URI]

          #[=" "] #[a.btn.btn-success(href="/widget/new") Add New Button]

    .body
      .container
        .row
          - each group in widgetsData
            .col-xs-12
              .group-header
                h4
                  a(data-toggle="collapse" href="##{group.uuid}" class="#{(group.widgets.length === 0) ? 'collapsed': ''}")
                    i(class="glyphicon glyphicon-chevron-#{(group.widgets.length === 0) ? 'right': 'down'}")
                    span #{group._id}
                .group-header-actions
                  a(href="#" ng-click='editSIPURI("#{group._id}")') Edit

              .sipCollapse.collapse.in(id="#{group.uuid}")
                if group.widgets.length > 0
                  table.table
                    thead
                      tr
                        td(width="25%") Configuration Name
                        td.text-center(width="45%") Button Preview
                        td.text-right Actions
                    tbody
                      - each widget in group.widgets
                        tr
                          td #{widget.configuration_name}
                          td.text-center
                            button(style="border: #{widget.button_color}; background: #{widget.button_color}" class="btn-#{widget.button_style}")
                              span #{widget.button_label || defaultBtnLabel}
                          td.text-right
                            #[button.btn.btn-sm.btn-primary.clipboard(widget-code="#{widget.divCode}") Copy Code] #[a.btn.btn-sm.btn-info(href="/widget/#{widget._id}/edit") View / Edit] #[button.deleteButton.btn.btn-sm.btn-danger(ng-click='openDeleteModal("#{widget._id}")') Delete]

    include contact-voxbone
    include ../sip/edit_modal
    include ../widget/delete_modal
